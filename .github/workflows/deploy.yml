name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false # Never cancel a running deploy

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Required Secrets (set in GitHub repo Settings â†’ Secrets):
#   GCP_PROJECT_ID          â€” Google Cloud project ID
#   GCP_REGION              â€” e.g. asia-southeast1
#   GCP_SA_KEY              â€” Service Account JSON key (or use WIF below)
#   MONGODB_URI             â€” MongoDB connection string
#   MONGODB_DATABASE        â€” MongoDB database name
#   JWT_SECRET              â€” HS256 signing secret (min 32 chars)
#   GOOGLE_CLIENT_ID        â€” Google OAuth 2.0 Client ID
#   GOOGLE_CLIENT_SECRET    â€” Google OAuth 2.0 Client Secret
#   GITHUB_CLIENT_ID        â€” GitHub OAuth App Client ID
#   GITHUB_CLIENT_SECRET    â€” GitHub OAuth App Client Secret
#   FRONTEND_URL            â€” Production frontend URL (e.g. https://gradiol.vercel.app)
#   REDIS_URL               â€” Redis connection string
#   VERCEL_TOKEN            â€” Vercel personal access token
#   VERCEL_ORG_ID           â€” Vercel organization/team ID
#   VERCEL_PROJECT_ID       â€” Vercel project ID
#
# Required Variables (set in GitHub repo Settings â†’ Variables):
#   VITE_API_URL            â€” Backend GCF URL (e.g. https://...-uc.a.run.app)
#
# Optional (Workload Identity Federation instead of SA key):
#   GCP_WIF_PROVIDER        â€” projects/*/locations/global/workloadIdentityPools/*/providers/*
#   GCP_WIF_SERVICE_ACCOUNT â€” sa-name@project.iam.gserviceaccount.com
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CI gate â€” must pass before deploy
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    name: CI Gate
    uses: ./.github/workflows/ci.yml

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Backend â†’ Google Cloud Functions Gen 2
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: Deploy Backend (GCF Gen 2)
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          # --- OR use Workload Identity Federation (recommended for prod) ---
          # workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          # service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy to Cloud Functions Gen 2
        working-directory: backend
        run: |
          gcloud functions deploy gradiol-api \
            --gen2 \
            --runtime=go123 \
            --region=${{ secrets.GCP_REGION }} \
            --source=. \
            --entry-point=GraDiOlAPI \
            --trigger-http \
            --allow-unauthenticated \
            --memory=256Mi \
            --timeout=60s \
            --min-instances=0 \
            --max-instances=10 \
            --set-env-vars="ENV=production,MONGODB_URI=${{ secrets.MONGODB_URI }},MONGODB_DATABASE=${{ secrets.MONGODB_DATABASE }},JWT_SECRET=${{ secrets.JWT_SECRET }},GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }},GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }},GITHUB_CLIENT_ID=${{ secrets.GITHUB_CLIENT_ID }},GITHUB_CLIENT_SECRET=${{ secrets.GITHUB_CLIENT_SECRET }},FRONTEND_URL=${{ secrets.FRONTEND_URL }},REDIS_URL=${{ secrets.REDIS_URL }}"

      - name: Verify deployment
        run: |
          FUNCTION_URL=$(gcloud functions describe gradiol-api \
            --gen2 \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(serviceConfig.uri)')
          echo "ğŸš€ Backend deployed to: $FUNCTION_URL"
          # Health check with retry (cold start can take 10-30s)
          for i in 1 2 3 4 5; do
            echo "Attempt $i: checking $FUNCTION_URL/api/health ..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$FUNCTION_URL/api/health")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed"
              exit 0
            fi
            echo "â³ Got HTTP $HTTP_CODE, retrying in 10s..."
            sleep 10
          done
          echo "âŒ Health check failed after 5 attempts"
          exit 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Frontend â†’ Vercel
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    name: Deploy Frontend (Vercel)
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Deploy to Vercel
        run: vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
