name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false # Never cancel a running deploy

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Required Secrets (set in GitHub repo Settings â†’ Secrets):
#   GCP_PROJECT_ID          â€” Google Cloud project ID
#   GCP_REGION              â€” e.g. asia-southeast1
#   GCP_SA_KEY              â€” Service Account JSON key (or use WIF below)
#   DATABASE_URL            â€” Supabase Pooler connection string
#   SUPABASE_JWT_SECRET     â€” Supabase JWT secret (from Project Settings â†’ API)
#   SUPABASE_URL            â€” Supabase project URL
#   SUPABASE_SERVICE_KEY    â€” Supabase service role key
#   FRONTEND_URL            â€” Production frontend URL (e.g. https://gradiol.vercel.app)
#   VERCEL_TOKEN            â€” Vercel personal access token
#   VERCEL_ORG_ID           â€” Vercel organization/team ID
#   VERCEL_PROJECT_ID       â€” Vercel project ID
#
# Required Variables (set in GitHub repo Settings â†’ Variables):
#   VITE_SUPABASE_URL       â€” Same as SUPABASE_URL (exposed to client)
#   VITE_SUPABASE_ANON_KEY  â€” Supabase anon key (exposed to client)
#   VITE_API_URL            â€” Backend GCF URL + /api suffix
#
# Optional (Workload Identity Federation instead of SA key):
#   GCP_WIF_PROVIDER        â€” projects/*/locations/global/workloadIdentityPools/*/providers/*
#   GCP_WIF_SERVICE_ACCOUNT â€” sa-name@project.iam.gserviceaccount.com
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CI gate â€” must pass before deploy
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    name: CI Gate
    uses: ./.github/workflows/ci.yml

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Backend â†’ Google Cloud Functions Gen 2
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: Deploy Backend (GCF Gen 2)
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          # --- OR use Workload Identity Federation (recommended for prod) ---
          # workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          # service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy to Cloud Functions Gen 2
        working-directory: backend
        run: |
          gcloud functions deploy gradiol-api \
            --gen2 \
            --runtime=go123 \
            --region=${{ secrets.GCP_REGION }} \
            --source=. \
            --entry-point=GraDiOlAPI \
            --trigger-http \
            --allow-unauthenticated \
            --memory=256Mi \
            --timeout=60s \
            --min-instances=0 \
            --max-instances=10 \
            --set-build-env-vars="GOOGLE_FUNCTION_SOURCE=gcf" \
            --set-env-vars="\
              ENV=production,\
              DATABASE_URL=${{ secrets.DATABASE_URL }},\
              SUPABASE_URL=${{ secrets.SUPABASE_URL }},\
              SUPABASE_JWT_SECRET=${{ secrets.SUPABASE_JWT_SECRET }},\
              SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }},\
              FRONTEND_URL=${{ secrets.FRONTEND_URL }},\
              REDIS_URL=${{ secrets.REDIS_URL }}"

      - name: Verify deployment
        run: |
          FUNCTION_URL=$(gcloud functions describe gradiol-api \
            --gen2 \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(serviceConfig.uri)')
          echo "ğŸš€ Backend deployed to: $FUNCTION_URL"
          # Health check
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FUNCTION_URL/api/health")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi
          echo "âœ… Health check passed"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Frontend â†’ Vercel
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    name: Deploy Frontend (Vercel)
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Pull Vercel environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build for production
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
